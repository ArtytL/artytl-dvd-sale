// === 1) REPLACE your existing sendEmail() with this version ===
async function sendEmail(to, subject, message, bccOwner = true){
  const owner = PRESET_OWNER.email;
  const payload = { to, subject, message, bcc: bccOwner ? owner : '' };

  // 1) Hit Vercel API (absolute URL so it works from anywhere)
  try{
    const resp = await fetch('https://artytl-dvd-sale.vercel.app/api/send-mail',{
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if(resp.ok) return true;
  }catch(err){ console.warn('serverless send failed', err); }

  // 2) Fallback: EmailJS (optional if you configured it)
  const cfg=getEmailCfg();
  if(cfg && cfg.publicKey && cfg.serviceId && cfg.templateId){
    try{
      await loadEmailJS(cfg.publicKey);
      const params={ to_email:to, subject, message, bcc: bccOwner? owner : '' };
      await emailjs.send(cfg.serviceId,cfg.templateId,params);
      return true;
    }catch(e){ console.error('emailjs failed', e); }
  }

  // 3) Final fallback: open default mail app
  const mailto='mailto:'+encodeURIComponent(to)
    +'?subject='+encodeURIComponent(subject)
    +'&body='+encodeURIComponent(message)
    +(bccOwner?('&bcc='+encodeURIComponent(owner)):'');
  window.open(mailto,'_blank');
  return false;
}

// === 2) ADD this helper to build the message body ===
function composeOrderEmail(order){
  const lines = order.items.map(it=>`• ${it.name} x ${it.qty} = ${THB(it.sum)}`).join('\n');
  const notifyUrl = (location && location.origin ? location.origin : 'https://artytl-dvd-sale.vercel.app') + '/#/notify';
  return (
`ขอบคุณสำหรับการสั่งสินค้าออเดอร์ (${order.id})\n\n`+
`รายการสินค้า:\n${lines}\n`+
`รวมค่าสินค้า: ${THB(order.subtotal)}\n`+
`ค่าส่ง (เหมาจ่าย): ${THB(order.shipping)}\n`+
`\nยอดชำระทั้งหมด: ${THB(order.total)}\n`+
`\nสำหรับการโอนเงิน\nบัญชี ธ.กรุงเทพ 047-007-8908 อาทิตย์ เลิศรักษ์มงคล\n`+
`\nหลังโอน โปรดกดลิงก์นี้เพื่อแจ้งชำระเงินและแนบสลิป:\n${notifyUrl}\n`+
`\nที่อยู่จัดส่ง:\n${order.address}\nเบอร์โทร: ${order.phone}`
  );
}

// === 3) In renderCheckout() submit handler, REPLACE email body usage ===
// Find this block:
//   if(method==='bank'){
//     const subject='วิธีชำระเงินสำหรับคำสั่งซื้อ '+orderId;
//     const body=bankEmailBody(order);
//     sendEmail(email,subject,body);
//     ...
//   } else { ... }
//
// Replace with:
//   const subject = 'ขอบคุณสำหรับการสั่งซื้อ '+orderId;
//   const body = composeOrderEmail(order);
//   sendEmail(email, subject, body, true);
//   // (bank/paypal เหมือนกัน ใช้ body เดียวเพื่อแจ้งยอด + ลิงก์แจ้งโอน)
