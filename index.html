<!doctype html>
<html lang="th">
<head>
  <!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DVD / Blu-ray Shop</title>

  <!-- Tailwind (CDN build for simplicity) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* basic fade */
    .fade-enter { opacity: 0; }
    .fade-enter-active { opacity: 1; transition: opacity .2s; }
    .soldout-badge { position:absolute; top:8px; left:8px; }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=THB"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBgdH-_1hC2Ck3Za5QqaeFVSMQmmR2QyUo",
      authDomain: "dvdbr-shop.firebaseapp.com",
      projectId: "dvdbr-shop",
      storageBucket: "dvdbr-shop.appspot.com",
      messagingSenderId: "24931876968",
      appId: "1:24931876968:web:3144ff90171ba8f887fbdd"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
  </script>
</head>

<body class="bg-zinc-50 text-zinc-900">
  <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì -->
</body>
</html>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DVD / Blu‚Äëray Shop</title>
  <!-- Tailwind (CDN build for simplicity) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* basic fade */
    .fade-enter { opacity: 0; }
    .fade-enter-active { opacity: 1; transition: opacity .2s; }
    .soldout-badge { position:absolute; top:8px; left:8px; }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <!-- PayPal (replace YOUR_CLIENT_ID) -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=THB"></script>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-zinc-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="#/" class="font-semibold tracking-tight">üé¨ DVDBR Shop</a>
      <nav class="flex items-center gap-3 text-sm">
        <a class="hover:underline" href="#/">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        <a class="hover:underline" href="#/dvd">DVD</a>
        <a class="hover:underline" href="#/bluray">Blu‚Äëray</a>
        <a class="hover:underline" href="#/contact">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</a>
        <a class="relative" href="#/cart" title="‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤">
          üõí<span id="cart-count" class="absolute -top-2 -right-2 bg-zinc-900 text-white text-[10px] px-1 rounded">0</span>
        </a>
        <a id="notify-link" class="hover:underline" href="#/notify">‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</a>
        <button id="admin-link" class="ml-3 text-xs px-2 py-1 rounded border">Admin</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div id="view"></div>
  </main>

  <footer class="border-t border-zinc-200 py-6 text-center text-xs text-zinc-500">
    ¬© <span id="y"></span> DVDBR Shop ‚Äî GitHub Pages + Firebase
  </footer>

<script>
  document.getElementById('y').textContent = new Date().getFullYear()

  // ====== CONFIG (edit these) ======
  const SHIPPING_FEE = 50;
  const ADMIN_EMAILS = ["you@example.com"]; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ
  const BANK_INFO = {
    bank: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á",
    name: "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á",
    number: "123-4-56789-0"
  };

  // Firebase web app config (replace placeholders)
  const firebaseConfig = {
  apiKey: "AIzaSyBgdH-_1hC2Ck3Za5QqaeFVSMQmmR2QyUo",
  authDomain: "dvdbr-shop.firebaseapp.com",
  projectId: "dvdbr-shop",
  storageBucket: "dvdbr-shop.appspot.com",
  messagingSenderId: "24931876968",
  appId: "1:24931876968:web:3144ff90171ba8f887fbdd",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ====== UTIL ======
  const $ = (sel, el=document)=> el.querySelector(sel)
  const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel))
  const fmt = n => Number(n).toLocaleString('th-TH')
  const uuid = () => Math.random().toString(36).slice(2)+Date.now().toString(36)

  function extractYouTubeId(url) {
    if (!url) return null;
    const m = url.match(/(?:youtu\.be\/|v=|\/embed\/)([\w-]{11})/);
    return m ? m[1] : null;
  }

  // local cart
  const CART_KEY = 'dvdbr_cart_v1'
  function getCart() { return JSON.parse(localStorage.getItem(CART_KEY)||'[]') }
  function setCart(items) { localStorage.setItem(CART_KEY, JSON.stringify(items)); updateCartCount(); }
  function addToCart(item) {
    const cart = getCart();
    const exists = cart.find(i=>i.sku===item.sku)
    if (exists) { exists.qty = Math.min(1, (exists.qty||1)); } // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô ‡∏à‡∏≥‡∏Å‡∏±‡∏î 1
    else cart.push({...item, qty:1});
    setCart(cart)
    alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß')
  }
  function updateCartCount(){ $('#cart-count').textContent = getCart().reduce((a,b)=>a+(b.qty||1),0) }
  updateCartCount()

  // Simple hash router
  const routes = {
    '': renderHome,
    '#/': renderHome,
    '#/dvd': () => renderCatalog('DVD'),
    '#/bluray': () => renderCatalog('Blu-ray'),
    '#/product': renderProduct,
    '#/cart': renderCart,
    '#/checkout': renderCheckout,
    '#/notify': renderNotify,
    '#/contact': renderContact,
    '#/admin': renderAdmin,
  }
  window.addEventListener('hashchange', router)
  window.addEventListener('load', router)

  async function router(){
    const hash = location.hash.split('?')[0]
    const fn = routes[hash] || renderHome
    await fn()
  }

  function view(html){
    const el = document.getElementById('view');
    el.innerHTML = html
  }

  // ====== DATA SHAPES ======
  // product: { sku, title, format: 'DVD'|'Blu-ray', price, stock, images:[url], youtubeUrl, description, createdAt }
  // order: { id, items:[{sku,title,price,qty}], subtotal, shipping, total, name,address,phone,email, method:'paypal'|'transfer', status, slipUrl?, createdAt }

  // ====== VIEWS ======
  async function renderHome(){
    const latest = await db.collection('products').orderBy('createdAt','desc').limit(8).get()
    const items = latest.docs.map(d=>({id:d.id, ...d.data()}))
    view(`<h1 class="text-xl font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h1>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${items.map(card).join('')}</div>`)
  }

  async function renderCatalog(format){
    const snap = await db.collection('products').where('format','==',format).orderBy('createdAt','desc').get()
    const items = snap.docs.map(d=>({id:d.id, ...d.data()}))
    view(`<h1 class="text-xl font-semibold mb-4">${format}</h1>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${items.map(card).join('')}</div>`)
  }

  function card(p){
    const img = (p.images&&p.images[0]) || 'https://placehold.co/600x800?text=No+Image'
    const sold = p.stock<=0
    return `<a href="#/product?sku=${encodeURIComponent(p.sku)}" class="block border rounded-xl overflow-hidden bg-white relative">
      ${sold?`<span class="soldout-badge bg-red-600 text-white text-[10px] px-2 py-1 rounded">SOLD OUT</span>`:''}
      <div class="aspect-[3/4] bg-zinc-100 overflow-hidden"><img src="${img}" alt="${p.title}" class="w-full h-full object-cover"/></div>
      <div class="p-3">
        <div class="text-sm text-zinc-500">${p.format}</div>
        <div class="font-medium line-clamp-2">${p.title}</div>
        <div class="mt-1">‡∏ø${fmt(p.price)}</div>
      </div>
    </a>`
  }

  async function renderProduct(){
    const url = new URL(location.href)
    const sku = url.searchParams.get('sku')
    const q = await db.collection('products').where('sku','==',sku).limit(1).get()
    if (q.empty) { view('<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>'); return }
    const p = q.docs[0].data()
    const yt = extractYouTubeId(p.youtubeUrl)
    const canBuy = p.stock>0

    view(`<div class="grid md:grid-cols-2 gap-6">
      <div>
        <div class="grid grid-cols-3 gap-2">
          ${(p.images||[]).slice(0,4).map(u=>`<img src="${u}" class="w-full aspect-square object-cover rounded"/>`).join('')}
        </div>
        ${yt?`<div class="mt-4 aspect-video"><iframe class="w-full h-full" src="https://www.youtube.com/embed/${yt}" allowfullscreen></iframe></div>`:''}
      </div>
      <div>
        <div class="text-sm text-zinc-500">${p.format} ‚Ä¢ SKU ${p.sku}</div>
        <h1 class="text-2xl font-semibold mt-1">${p.title}</h1>
        <div class="text-xl mt-2">‡∏ø${fmt(p.price)}</div>
        <div class="mt-2 ${canBuy? 'text-emerald-600':'text-red-600'}">${canBuy?`‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô`:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î'}</div>
        <div class="prose prose-zinc max-w-none mt-4">${(p.description||'').replace(/\n/g,'<br>')}</div>
        <div class="mt-6 flex items-center gap-3">
          <button ${canBuy?'':'disabled'} class="px-4 py-2 rounded bg-zinc-900 text-white disabled:opacity-40" id="add">Add to cart</button>
          <a ${canBuy?'':'aria-disabled'} href="${canBuy?'#/checkout?buy='+encodeURIComponent(p.sku):'#'}" class="px-4 py-2 rounded border">‡∏™‡∏±‡πà‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</a>
        </div>
      </div>
    </div>`)

    $('#add')?.addEventListener('click',()=>{
      addToCart({ sku:p.sku, title:p.title, price:p.price, format:p.format })
    })
  }

  function renderCart(){
    const cart = getCart()
    if (!cart.length) { view('<p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>'); return }
    const subtotal = cart.reduce((a,b)=>a+b.price*(b.qty||1),0)
    view(`<h1 class="text-xl font-semibold mb-4">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
      <div class="space-y-3">${cart.map(i=>`
        <div class="flex items-center justify-between border rounded p-3">
          <div>
            <div class="text-sm text-zinc-500">${i.format} ‚Ä¢ ${i.sku}</div>
            <div class="font-medium">${i.title}</div>
          </div>
          <div>‡∏ø${fmt(i.price)}</div>
        </div>`).join('')}
      </div>
      <div class="mt-4 flex justify-between text-sm"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span>‡∏ø${fmt(subtotal)}</span></div>
      <div class="mt-1 flex justify-between text-sm"><span>‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</span><span>‡∏ø${fmt(SHIPPING_FEE)}</span></div>
      <div class="mt-2 flex justify-between font-semibold"><span>Total</span><span>‡∏ø${fmt(subtotal+SHIPPING_FEE)}</span></div>
      <div class="mt-4">
        <a href="#/checkout" class="px-4 py-2 rounded bg-zinc-900 text-white">‡πÑ‡∏õ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</a>
      </div>`)
  }

  async function renderCheckout(){
    const url = new URL(location.href)
    const buySku = url.searchParams.get('buy')
    let cart = getCart()
    if (buySku) {
      // buy single item direct
      const q = await db.collection('products').where('sku','==',buySku).limit(1).get()
      if (!q.empty) {
        const p = q.docs[0].data()
        cart = [{ sku:p.sku, title:p.title, price:p.price, format:p.format, qty:1 }]
      }
    }
    if (!cart.length){ view('<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>'); return }
    const subtotal = cart.reduce((a,b)=>a+b.price*(b.qty||1),0)
    const total = subtotal + SHIPPING_FEE

    view(`<h1 class="text-xl font-semibold mb-4">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h1>
      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
          <div class="border rounded p-4">
            <h2 class="font-medium">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</h2>
            <div class="mt-3 flex gap-3">
              <button id="pay-paypal" class="px-3 py-2 border rounded">PayPal</button>
              <button id="pay-transfer" class="px-3 py-2 border rounded">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
            <div id="pay-area" class="mt-4"></div>
          </div>
        </div>
        <div class="border rounded p-4 h-fit">
          <div class="font-medium">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
          <div class="mt-2 text-sm space-y-1">
            ${cart.map(i=>`<div class="flex justify-between"><span>${i.title}</span><span>‡∏ø${fmt(i.price)}</span></div>`).join('')}
            <div class="flex justify-between"><span>‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</span><span>‡∏ø${fmt(SHIPPING_FEE)}</span></div>
            <div class="flex justify-between font-semibold"><span>Total</span><span>‡∏ø${fmt(total)}</span></div>
          </div>
        </div>
      </div>`)

    $('#pay-paypal').addEventListener('click', ()=>
      showPaypal(cart, subtotal, total)
    )
    $('#pay-transfer').addEventListener('click', ()=>
      showTransfer(cart, subtotal, total)
    )
  }

  function showPaypal(cart, subtotal, total){
    const el = $('#pay-area');
    el.innerHTML = `<div id="paypal-buttons"></div>`
    if (!window.paypal){ el.innerHTML = '<p class="text-red-600">‡πÇ‡∏´‡∏•‡∏î PayPal SDK ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>'; return }
    paypal.Buttons({
      createOrder: (_, actions) => actions.order.create({ purchase_units:[{ amount:{ value: total.toFixed(2) } }] }),
      onApprove: async (_, actions) => {
        const details = await actions.order.capture();
        const orderId = details.id || uuid();
        await saveOrder({ id:orderId, items:cart, subtotal, shipping:SHIPPING_FEE, total, method:'paypal', status:'paid_paypal' })
        await decrementStocks(cart)
        setCart([])
        location.hash = '#/thankyou'
        alert('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: '+orderId)
      },
      onError: (err)=> alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î PayPal: '+err)
    }).render('#paypal-buttons');
  }

  function showTransfer(cart, subtotal, total){
    const el = $('#pay-area');
    el.innerHTML = `<div class="space-y-3">
      <div class="text-sm">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Confirm ‡∏à‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á ‡∏ø${fmt(SHIPPING_FEE)} = <b>‡∏ø${fmt(total)}</b> ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô</div>
      <form id="tf" class="grid grid-cols-1 gap-3">
        <input required name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="border rounded px-3 py-2"/>
        <textarea required name="address" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" class="border rounded px-3 py-2"></textarea>
        <input required name="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" class="border rounded px-3 py-2"/>
        <input required type="email" name="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="border rounded px-3 py-2"/>
        <button class="px-3 py-2 rounded bg-zinc-900 text-white w-fit">Confirm</button>
      </form>
      <div id="after"></div>
    </div>`
    $('#tf').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const f = Object.fromEntries(new FormData(e.target).entries())
      const id = 'TF-'+uuid()
      await saveOrder({ id, items:cart, subtotal, shipping:SHIPPING_FEE, total, method:'transfer', status:'awaiting_transfer', ...f })
      $('#after').innerHTML = `<div class="border rounded p-3">
        <div class="font-medium">‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏£‡∏ß‡∏°: ‡∏ø${fmt(total)}</div>
        <div class="mt-2 text-sm">‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <b>${BANK_INFO.bank}</b> / ${BANK_INFO.name} / ${BANK_INFO.number}</div>
        <div class="mt-3">
          <label class="text-sm">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</label>
          <input id="slip" type="file" accept="image/*" class="block mt-1" />
          <button id="uploadSlip" class="mt-2 px-3 py-2 rounded border">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</button>
        </div>
        <div class="mt-3 text-xs text-zinc-500">‡∏´‡∏≤‡∏Å‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π ‚Äú‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: <b>${id}</b></div>
      </div>`
      $('#uploadSlip').addEventListener('click', async ()=>{
        const file = $('#slip').files[0]; if (!file) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô')
        const ref = storage.ref('slips/'+id+'/'+file.name)
        const snap = await ref.put(file)
        const url = await snap.ref.getDownloadURL()
        await db.collection('orders').doc(id).update({ slipUrl:url, status:'awaiting_verification' })
        alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')
      })
      // ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
      setCart([])
    })
  }

  async function saveOrder(order){
    order.createdAt = firebase.firestore.FieldValue.serverTimestamp()
    await db.collection('orders').doc(order.id).set(order)
  }
  async function decrementStocks(items){
    const batch = db.batch()
    for (const it of items){
      const qs = await db.collection('products').where('sku','==',it.sku).limit(1).get()
      if (!qs.empty){
        const ref = qs.docs[0].ref
        batch.update(ref, { stock: firebase.firestore.FieldValue.increment(-1) })
      }
    }
    await batch.commit()
  }

  function renderNotify(){
    view(`<h1 class="text-xl font-semibold mb-4">‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô)</h1>
      <form id="nf" class="max-w-md space-y-3">
        <input required name="id" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô TF-xxxx)" class="border rounded px-3 py-2 w-full"/>
        <input required type="file" id="slip2" accept="image/*" class="w-full"/>
        <button class="px-4 py-2 rounded bg-zinc-900 text-white">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</button>
      </form>`)
    $('#nf').addEventListener('submit', async (e)=>{
      e.preventDefault()
      const id = new FormData(e.target).get('id')
      const file = $('#slip2').files[0]; if (!file) return alert('‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô')
      const ref = storage.ref('slips/'+id+'/'+file.name)
      const snap = await ref.put(file)
      const url = await snap.ref.getDownloadURL()
      await db.collection('orders').doc(id).update({ slipUrl:url, status:'awaiting_verification' })
      alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')
    })
  }

  function renderContact(){
    view(`<div class="prose prose-zinc max-w-none">
      <h1>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h1>
      <p>‡∏≠‡∏µ‡πÄ‡∏°‡∏•: you@example.com<br>LINE: @yourline</p>
    </div>`)
  }

  // ====== ADMIN ======
  $('#admin-link').addEventListener('click', ()=> location.hash = '#/admin')

  async function renderAdmin(){
    view(`<div id="admin">
      <h1 class="text-xl font-semibold mb-4">‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h1>
      <div id="auth"></div>
      <div id="panel" class="hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="border rounded p-4">
            <h2 class="font-medium mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
            <form id="pf" class="space-y-2">
              <input required name="title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" class="border rounded px-3 py-2 w-full"/>
              <select name="format" class="border rounded px-3 py-2 w-full">
                <option>DVD</option><option>Blu-ray</option>
              </select>
              <input required name="price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="border rounded px-3 py-2 w-full"/>
              <input required name="stock" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)" class="border rounded px-3 py-2 w-full"/>
              <textarea name="description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="border rounded px-3 py-2 w-full"></textarea>
              <input name="youtubeUrl" placeholder="YouTube URL (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="border rounded px-3 py-2 w-full"/>
              <label class="text-sm">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4 ‡∏£‡∏π‡∏õ)</label>
              <input id="imgs" type="file" multiple accept="image/*" class="w-full"/>
              <button class="mt-2 px-4 py-2 rounded bg-zinc-900 text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </form>
          </div>
          <div class="border rounded p-4">
            <h2 class="font-medium mb-2">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
            <div id="orders" class="space-y-3 text-sm"></div>
          </div>
        </div>
      </div>
    </div>`)

    // auth block
    auth.onAuthStateChanged(user=>{
      const authel = $('#auth')
      if (!user){
        authel.innerHTML = `<button id="signin" class="px-3 py-2 border rounded">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google</button>`
        $('#panel').classList.add('hidden')
        $('#signin').onclick = async ()=>{
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithPopup(provider)
        }
      } else {
        const isAdmin = ADMIN_EMAILS.includes(user.email)
        authel.innerHTML = `<div class="flex items-center gap-3 text-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ${user.email} ${isAdmin?'<span class=\'text-emerald-600\'>(admin)</span>':'<span class=\'text-red-600\'>(no admin)</span>'} <button id="logout" class="px-2 py-1 border rounded">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>`
        $('#logout').onclick = ()=> auth.signOut()
        if (isAdmin){ $('#panel').classList.remove('hidden'); initAdminPanel(); }
      }
    })
  }

  async function initAdminPanel(){
    // orders feed
    db.collection('orders').orderBy('createdAt','desc').limit(20).onSnapshot(snap=>{
      const list = snap.docs.map(d=>({id:d.id, ...d.data()}))
      $('#orders').innerHTML = list.map(o=>`
        <div class="border rounded p-3">
          <div class="flex justify-between">
            <div><b>${o.id}</b> ‚Ä¢ ${o.method} ‚Ä¢ <span class="${o.status.includes('await')?'text-amber-600':o.status.includes('paid')?'text-emerald-600':'text-zinc-700'}">${o.status}</span></div>
            <div>‡∏ø${fmt(o.total)}</div>
          </div>
          <div class="mt-1">${o.items.map(i=>i.title+' ('+i.sku+')').join(', ')}</div>
          ${o.name?`<div class="mt-1 text-xs">${o.name} ‚Ä¢ ${o.phone} ‚Ä¢ ${o.email}<br>${(o.address||'').replace(/\n/g,' ')}</div>`:''}
          ${o.slipUrl?`<div class="mt-1"><a class="text-blue-600 underline" href="${o.slipUrl}" target="_blank">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a></div>`:''}
          <div class="mt-2 flex gap-2">
            <button data-id="${o.id}" data-act="mark-paid" class="px-2 py-1 border rounded">‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</button>
            <button data-id="${o.id}" data-act="ready" class="px-2 py-1 border rounded">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</button>
          </div>
        </div>
      `).join('')
      $$('#orders [data-act]').forEach(btn=>btn.addEventListener('click', async ()=>{
        const id = btn.dataset.id
        const act = btn.dataset.act
        const status = act==='mark-paid'?'paid_transfer':'ready_to_ship'
        await db.collection('orders').doc(id).update({ status })
        if (act==='mark-paid'){
          // cut stock here for transfer method after verify
          const oDoc = await db.collection('orders').doc(id).get()
          const o = oDoc.data()
          await decrementStocks(o.items)
        }
        alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß: '+status)
      }))
    })

    // product form
    $('#pf').addEventListener('submit', async (e)=>{
      e.preventDefault()
      const f = Object.fromEntries(new FormData(e.target).entries())
      const sku = await nextSku()
      const images = await uploadImages(sku)
      const doc = {
        sku,
        title: f.title,
        format: f.format,
        price: Number(f.price||0),
        stock: Number(f.stock||0),
        description: f.description||'',
        youtubeUrl: f.youtubeUrl||'',
        images,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      }
      await db.collection('products').doc(sku).set(doc)
      alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ SKU '+sku)
      e.target.reset()
    })
  }

  async function uploadImages(sku){
    const input = document.getElementById('imgs')
    const files = Array.from(input.files||[]).slice(0,4)
    const urls = []
    for (const f of files){
      const ref = storage.ref(`products/${sku}/${Date.now()}_${f.name}`)
      const snap = await ref.put(f)
      urls.push(await snap.ref.getDownloadURL())
    }
    return urls
  }

  async function nextSku(){
    const ref = db.collection('meta').doc('sku')
    await db.runTransaction(async (tx)=>{
      const doc = await tx.get(ref)
      const cur = doc.exists ? (doc.data().seq||1000) : 1000
      tx.set(ref, { seq: cur+1 })
    })
    const doc = await ref.get();
    return 'SKU'+String(doc.data().seq).padStart(5,'0')
  }
</script>
</body>
</html>
